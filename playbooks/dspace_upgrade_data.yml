---
- name: stop dspace before upgrading data
  hosts: app_not_prod
  become: true

  tasks:
  - name: stop dspace before upgrading data
    include: tasks/stop_app.yml

- name: install extensions
  hosts: db_not_prod
  become: true

  tasks:
  - name: set version-specific vars
    include_role:
      name: postgres
      tasks_from: set_vars
    vars:
      upgrading: false
      version_major: "{{ postgres_version_major }}"
      version_minor: "{{ postgres_version_minor }}"

  - name: install extensions
    include_role:
      name: postgres
      tasks_from: extensions
    vars:
      databases:      "{{ postgres_databases }}"
      extra_packages: "{{ postgres_extra_packages }}"
      extensions:     "{{ postgres_extensions }}"

- name: upgrade dspace data generated by a previous version to be compatible with the current install
  hosts: app_not_prod
  become: true

  tasks:
    - name: upgrade data
      include_role:
        name: dspace-6
        tasks_from: upgrade_data

    - name: restart dspace after upgrading data
      include: tasks/start_app.yml
